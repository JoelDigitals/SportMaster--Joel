{% extends "base.html" %}
{% block title %}{{ team.name }} — Mitglieder{% endblock %}
{% block content %}
<div class="grid md:grid-cols-3 gap-6">
  <main class="md:col-span-2 card">
    <div class="flex justify-between items-center">
      <h1 class="text-2xl font-bold">{{ team.name }}</h1>
      <div class="muted text-sm">Verein: {{ team.club.name }}</div>
    </div>

    <!-- Aufstellungen: nur kommende Spiele anzeigen -->
    <section class="mt-6">
      <h2 class="font-semibold">Aufstellungen (kommende Spiele)</h2>
      <div class="space-y-3 mt-3">
        {% for l in lineups %}
          {% if l.date %}
            {% if l.date >= now %}
              <div class="p-3 border rounded">
                <div class="flex justify-between">
                  <div>
                    <strong>{{ l.name }}</strong>
                    <div class="muted text-xs">{{ l.date }}</div>
                  </div>
                  <div>
                    {% if l.is_public %}<span class="px-2 py-0.5 bg-green-100 text-green-800 rounded text-sm">Öffentlich</span>{% endif %}
                    {% if user in team.trainers.all %}
                      <a href="{% url 'lineup_edit' team.slug l.pk %}" class="text-blue-600 ml-2">Bearbeiten</a>
                    {% endif %}
                  </div>
                </div>
                <div class="mt-2 text-sm">
                  Spieler:
                  <ul class="list-disc ml-5">
                    {% for p in l.players.all %}
                      <li>{{ p.get_full_name|default:p.username }}</li>
                    {% empty %}
                      <li class="muted">Keine Spieler</li>
                    {% endfor %}
                  </ul>
                </div>
              </div>
            {% endif %}
          {% endif %}
        {% empty %}
          <p class="muted">Keine Aufstellungen vorhanden.</p>
        {% endfor %}
      </div>
    </section>

    <!-- Trainings: nur nächste 6 -->
    <section class="mt-6">
      <h2 class="font-semibold">Nächste Trainings</h2>
      <ul class="mt-3 space-y-3">
        {% for t in trainings|slice:":6" %}
          <li class="p-3 border rounded flex justify-between items-center">
            <div>
              <div class="font-medium">{{ t.start|date:"d.m.Y H:i" }} — {{ t.location }}</div>
              {% if t.note %}<div class="muted text-sm">{{ t.note }}</div>{% endif %}
              <div class="text-xs muted mt-1">
                Zugesagt:
                {% for r in t.rsvps.all %}
                  {% if r.status == 'yes' %}
                    <span class="inline-block px-2 py-0.5 text-xs border rounded mr-1">{{ r.user.get_full_name|default:r.user.username }}</span>
                  {% endif %}
                {% empty %}
                  <span class="muted">Keine</span>
                {% endfor %}
              </div>
            </div>

            <!-- RSVP Buttons -->
            <div class="flex gap-2">
              <form method="post" action="{% url 'training_rsvp' team.slug t.pk %}">
                {% csrf_token %}
                <input type="hidden" name="status" value="yes" />
                <button class="px-3 py-1 border rounded bg-green-600 text-white">✔️ Zusagen</button>
              </form>

              <form onsubmit="openDeclineModal(event, '{{ t.pk }}');" class="inline">
                {% csrf_token %}
                <button type="button" class="px-3 py-1 border rounded bg-red-600 text-white">❌ Absagen</button>
              </form>

              <form method="post" action="{% url 'training_rsvp' team.slug t.pk %}">
                {% csrf_token %}
                <input type="hidden" name="status" value="maybe" />
                <button class="px-3 py-1 border rounded bg-yellow-600 text-white">Vielleicht</button>
              </form>
            </div>
          </li>
        {% empty %}
          <li class="muted">Keine anstehenden Trainings.</li>
        {% endfor %}
      </ul>
    </section>

    <!-- Chat include -->
    <section class="mt-6">
      {% include "teams/chat_inc.html" %}
    </section>
  </main>

  <aside class="card">
    <h3 class="font-semibold">Kurzinfo & Aktionen</h3>
    <p class="muted"><strong>Trainer:</strong></p>
    <ul class="mt-2">
      {% for tr in team.trainers.all %}
        <li class="text-sm">{{ tr.get_full_name|default:tr.username }}</li>
      {% empty %}
        <li class="muted">Keine Trainer</li>
      {% endfor %}
    </ul>

    <div class="mt-4 space-y-2">
      {% if user in team.trainers.all %}
        <a href="{% url 'training_event_create' team.slug %}" class="block text-center px-3 py-2 border rounded bg-yellow-600 text-white">➕ Einzel-Training</a>
        <a href="{% url 'training_series_create' team.slug %}" class="block text-center px-3 py-2 border rounded bg-indigo-600 text-white">➕ Trainingsserie</a>
        <a href="{% url 'lineup_create' team.slug %}" class="block text-center px-3 py-2 border rounded bg-green-600 text-white">➕ Aufstellung</a>
      {% endif %}
      <a href="{% url 'members_list' team.slug %}" class="block text-center px-3 py-2 border rounded">Alle Mitglieder</a>
      <a href="{% url 'penalties_list' team.slug %}" class="block text-center px-3 py-2 border rounded">Strafenkatalog</a>
    </div>
  </aside>
</div>

<script>
  function openDeclineModal(evt, trainingId) {
    evt.preventDefault();
    const html = `
      <h3 class="font-semibold">Absage-Grund</h3>
      <form id="declineForm" method="post" action="{% url 'training_rsvp' team.slug 0 %}".replace('/0/','/' + trainingId + '/')>
        {% csrf_token %}
        <input type="hidden" name="status" value="no" />
        <textarea name="comment" rows="4" class="w-full border rounded p-2" placeholder="Grund für Absage (optional)"></textarea>
        <div class="mt-3 text-right">
          <button type="submit" class="px-3 py-1 bg-red-600 text-white rounded">Absagen</button>
        </div>
      </form>`;
    openModal(html);
  }
</script>
{% endblock %}
